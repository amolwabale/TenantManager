import { Hono } from "npm:hono";
import { cors } from "npm:hono/cors";
import { logger } from "npm:hono/logger";
import { createClient } from "npm:@supabase/supabase-js@2";

const app = new Hono();

app.use("*", cors({
  origin: "*",
  allowMethods: ["GET", "POST", "PUT", "DELETE", "OPTIONS"],
  allowHeaders: ["Content-Type", "Authorization"],
  exposeHeaders: ["Content-Length"],
  maxAge: 86400,
}));
app.use("*", logger(console.log));

const supabase = createClient(
  Deno.env.get("SUPABASE_URL")!,
  Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!
);

Deno.serve(app.fetch);

// Health check
app.get("/tenant-manager/health", (c) => {
  return c.json({ status: "ok" });
});

// Register user
app.post("/tenant-manager/register", async (c) => {
  const body = await c.req.json();

  const {
    email,
    password,
    firstName,
    lastName,
    mobile,
    address,
  } = body;

  if (!email || !password || !firstName || !lastName) {
    return c.json({ error: "Missing required fields" }, 400);
  }

  // 1️⃣ Create Auth user
  const { data: authData, error: authError } =
    await supabase.auth.admin.createUser({
      email,
      password,
      email_confirm: true,
    });

  if (authError || !authData.user) {
    return c.json({ error: authError?.message }, 400);
  }

  const authUserId = authData.user.id;

  // 2️⃣ Insert into custom User table
  const { error: dbError } = await supabase
    .from("User")
    .insert({
      user_id: authUserId,
      email,
      first_name: firstName,
      last_name: lastName,
      mobile,
      address,
    });

  if (dbError) {
    return c.json({ error: dbError.message }, 500);
  }

  return c.json({
    success: true,
    userId: authUserId,
  });
});